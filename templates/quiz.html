{% extends "base.html" %}
{% block title %}Quiz — {{ course_num }}{% endblock %}
{% block content %}
<!-- Progress Bar (Sticky at top) -->
<div class="fixed top-20 sm:top-24 left-0 right-0 z-40 bg-white border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-2 sm:px-4 py-2">
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-orange-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>

<div id="quiz-container" class="max-w-3xl mx-auto px-2 sm:px-4 pt-8">
    <div id="quiz-loading" class="text-center py-16">
        <div class="animate-spin rounded-full h-12 w-12 sm:h-16 sm:w-16 border-b-2 border-blue-900 mx-auto"></div>
        <p class="mt-4 text-sm sm:text-base text-gray-600">Loading study set for Course {{ course_num }}...</p>
    </div>

    <div id="quiz-app" class="hidden">
        <!-- Question centered with answers and feedback visible -->
        <div class="flex flex-col items-center min-h-screen pb-24">
            <!-- Question -->
            <div class="w-full max-w-2xl mt-8 mb-8">
                <h2 id="question-text" class="text-2xl sm:text-3xl font-bold text-slate-800 text-center leading-relaxed"></h2>
            </div>

            <!-- Options Grid -->
            <div id="options-grid" class="w-full max-w-2xl grid grid-cols-1 gap-3 sm:gap-4 mb-8">
            </div>

            <!-- Feedback Area (appears below answers) -->
            <div id="feedback-area" class="hidden w-full max-w-2xl mt-8 p-4 sm:p-6 rounded-xl border-2 transition-all">
                <h3 id="feedback-title" class="font-bold text-base sm:text-lg mb-3 sm:mb-4"></h3>
                <p id="reasoning-text" class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-6 leading-relaxed"></p>
                <button onclick="nextQuestion()" class="w-full bg-blue-900 text-white py-2.5 sm:py-3 rounded-lg font-bold hover:bg-slate-800 text-sm sm:text-base transition">
                    Next Question
                </button>
            </div>
        </div>
    </div>

    <div id="results-area" class="hidden">
        <div class="max-w-2xl mx-auto text-center py-16">
            <h2 class="text-3xl sm:text-4xl font-black text-blue-900 mb-2">Quiz Complete!</h2>
            <p class="text-base sm:text-lg text-gray-600 mb-6 sm:mb-8">Your UTSA Readiness Score</p>
            <div class="text-5xl sm:text-6xl font-bold text-orange-600 mb-8" id="final-score">0%</div>

            <div id="incorrect-section" class="mb-12 hidden">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 text-left">Problems You Missed</h3>
                <div id="incorrect-list" class="space-y-4">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center">
                <button onclick="restartQuiz()" class="bg-blue-600 text-white px-6 sm:px-8 py-2.5 sm:py-3 rounded-lg font-bold hover:bg-blue-700 text-sm sm:text-base transition">Restart Quiz</button>
                <button onclick="goToCourse()" class="bg-slate-600 text-white px-6 sm:px-8 py-2.5 sm:py-3 rounded-lg font-bold hover:bg-slate-700 text-sm sm:text-base transition">Back to Course</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestions = [];
let currentIndex = 0;
let score = 0;
let incorrectAnswers = [];

async function loadQuiz() {
    try {
        const response = await fetch(`/static/courses/{{ course_num }}/{{ week }}.json`);
        const data = await response.json();
        
        // Shuffle and use all questions (up to 10)
        currentQuestions = data.sort(() => 0.5 - Math.random()).slice(0, 10);
        
        document.getElementById('quiz-loading').classList.add('hidden');
        document.getElementById('quiz-app').classList.remove('hidden');
        showQuestion();
    } catch (err) {
        console.error("Failed to load quiz:", err);
        document.getElementById('quiz-loading').innerHTML = "Error loading questions. Check file path.";
    }
}

function showQuestion() {
    const q = currentQuestions[currentIndex];
    document.getElementById('question-text').innerText = q.q;
    const grid = document.getElementById('options-grid');
    grid.innerHTML = '';
    document.getElementById('feedback-area').classList.add('hidden');
    
    q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = "w-full text-left p-4 sm:p-5 border-2 border-gray-200 rounded-lg sm:rounded-xl hover:border-blue-500 hover:bg-blue-50 transition font-medium text-sm sm:text-base active:scale-95";
        btn.innerText = opt;
        btn.onclick = () => checkAnswer(idx);
        grid.appendChild(btn);
    });

    const progress = ((currentIndex) / currentQuestions.length) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
}

function checkAnswer(choice) {
    const q = currentQuestions[currentIndex];
    const feedback = document.getElementById('feedback-area');
    const title = document.getElementById('feedback-title');
    
    // Disable all option buttons
    const buttons = document.querySelectorAll('#options-grid button');
    buttons.forEach(b => b.disabled = true);

    if(choice === q.correct) {
        score++;
        title.innerText = "Correct! ✅";
        title.className = "font-bold text-lg mb-2 text-green-700";
        feedback.className = "mt-8 p-6 rounded-xl bg-green-50 border border-green-200";
    } else {
        title.innerText = "Incorrect ❌";
        title.className = "font-bold text-lg mb-2 text-red-700";
        feedback.className = "mt-8 p-6 rounded-xl bg-red-50 border border-red-200";
        
        // Track incorrect answers
        incorrectAnswers.push({
            question: q.q,
            yourAnswer: q.options[choice],
            correctAnswer: q.options[q.correct],
            reasoning: q.reasoning
        });
    }

    document.getElementById('reasoning-text').innerText = q.reasoning;
    feedback.classList.remove('hidden');
}

function nextQuestion() {
    currentIndex++;
    if(currentIndex < currentQuestions.length) {
        showQuestion();
    } else {
        showResults();
    }
}

function showResults() {
    document.getElementById('quiz-app').classList.add('hidden');
    document.getElementById('results-area').classList.remove('hidden');
    document.getElementById('progress-bar').style.width = `100%`;
    const finalPct = Math.round((score / currentQuestions.length) * 100);
    document.getElementById('final-score').innerText = finalPct + "%";

    // Display incorrect answers if any
    if(incorrectAnswers.length > 0) {
        document.getElementById('incorrect-section').classList.remove('hidden');
        const incorrectList = document.getElementById('incorrect-list');
        incorrectList.innerHTML = '';
        
        incorrectAnswers.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'border-l-4 border-red-500 pl-4 py-4 bg-red-50 rounded-lg';
            div.innerHTML = `
                <p class="font-bold text-gray-800 mb-2">${idx + 1}. ${item.question}</p>
                <p class="text-sm text-gray-700 mb-2"><span class="font-semibold">Your answer:</span> ${item.yourAnswer}</p>
                <p class="text-sm text-green-700 mb-2"><span class="font-semibold">Correct answer:</span> ${item.correctAnswer}</p>
                <p class="text-sm text-gray-600 italic">${item.reasoning}</p>
            `;
            incorrectList.appendChild(div);
        });
    }
}

function restartQuiz() {
    currentIndex = 0;
    score = 0;
    incorrectAnswers = [];
    document.getElementById('results-area').classList.add('hidden');
    document.getElementById('progress-bar').style.width = `0%`;
    document.getElementById('quiz-app').classList.remove('hidden');
    showQuestion();
}

function goToCourse() {
    window.location.href = `/course/{{ course_num }}`;
}

window.onload = loadQuiz;
</script>
{% endblock %}